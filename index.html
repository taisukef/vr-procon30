<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<title>VR-Sabae</title>
	<script src="https://aframe.io/releases/0.9.1/aframe.min.js"></script>
</head>
<body>
<script>"use strict"
window.onload = function() {
	const ua = navigator.userAgent
	const oculus = ua.toLowerCase().indexOf("oculus") >= 0
	if (!oculus) {
		camera.setAttribute("position", { x: 0, y: 1.7, z: 0 })
	}

	let list = []
	for (let i = 0; i <= 13; i++) {
		const no = i < 10 ? "0" + i : i
		list.push("img/vr-procon30-" + no + ".jpg")
	}
	let cur = 0

	const scene = document.querySelector('a-scene')
	const sky = document.createElement('a-sky')
	const dir = 230
	sky.setAttribute('rotation', "0 " + dir + " 0")
	scene.appendChild(sky)

	let loading = false
	const set = function(url) {
		console.log(url, loading, cur)
		if (loading)
			return false
		const img = new Image()
		img.src = url
		loading = true
		img.onload = function() {
			loading = false
			sky.setAttribute('src', this.src)
		}
		return true
	}
	set(list[cur])

	const next = function() {
		if (!loading && list.length > 0) {
			if (cur == list.length - 1)
				cur = 0
			else
				cur++
			set(list[cur])
		}
	}
	const prev = function() {
		if (!loading && list.length > 0) {
			if (cur == 0)
				cur = cur.length - 1
			else
				cur--
			set(list[cur])
		}
	}

	handright.addEventListener('triggerdown', function(evt) {
		next()
	})

	const zoomctrl = function(btn, callback) {
		const w = 1000 / 30
		btn.addEventListener('mouseenter', async function() {
			for (let i = 1; i < 1.3; i += .05) {
				this.setAttribute('scale', { x: i, y: i, z: i })
				await wait(w)
			}
			callback()
		})
		btn.addEventListener('mouseleave', async function() {
			for (let i = 1.3; i >= 1.0; i -= .05) {
				this.setAttribute('scale', { x: i, y: i, z: i })
				await wait(w)
			}
		})
	}
	zoomctrl(snext, function() { next() })
	zoomctrl(sprev, function() { prev() })
}
const wait = async function(n) {
	new Promise(function(result) {
		setTimeout(result, n)
	})
}
</script>

<a-scene id="scene">
	<a-entity id=handleft oculus-touch-controls="hand: left"></a-entity>
	<a-entity id=handright oculus-touch-controls="hand: right"></a-entity>

	<a-sphere id="snext" position=".5 1.0 -1" radius=".15" color="#EF2D5E"></a-sphere>
	<a-text position=".5 1.1 -.8" value="next" align="center" color="#fff" rotation="-25 0 0"></a-text>
	<a-sphere id="sprev" position="-.5 1.0 -1" radius=".15" color="#EF2D5E"></a-sphere>
	<a-text position="-.5 1.1 -.8" value="prev" align="center" color="#fff" rotation="-25 0 0"></a-text>

	<a-entity id="camera" camera look-controls>
			<a-cursor></a-cursor>
	</a-entity>
</a-scene>				

</body>
</html>
